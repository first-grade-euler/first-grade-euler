<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/favicon.ico">
    <link rel="apple-touch-startup-image" href="/favicon.ico">
    <meta name="apple-mobile-web-app-title" content="Euler">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <!--CSS and javascript-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/4.0.2/bootstrap-material-design.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Ripple.js/1.2.1/ripple.min.css">
    <link rel="stylesheet" href="css/index.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/4.0.2/bootstrap-material-design.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Ripple.js/1.2.1/ripple.min.js"></script>

    <title>First Grade Euler</title>
</head>
<body>

Hi, Euler!

<div id="output-container">
    <div id="output">
        <!-- Output Image-->
    </div>
</div>

<div class="center">
    <form enctype="multipart/form-data">
        <div class="btn-group">
            <a class="btn btn-link" href=".">
                First Grade Euler
            </a>
            <label for="input" class="btn btn-info btn-raised">Upload
                <input name="file" type="file" id="input" accept="image/jpeg, image/png" style="display: none;">
            </label>
        </div>
    </form>
</div>

</body>

<script>
    const PROXY_URL = 'http://10.10.7.160:1337/';
    const AUTH = 'Basic Zmlyc3QtZ3JhZGUtZXVsZXI6dDQwQko1YUs5OTZZN2hzRjFWREIxdUtW';

    const INPUT = document.getElementById('input');
    const OUTPUT = document.getElementById('output');

    INPUT.addEventListener('change', function (e) {
        if (this.files.length > 0) {
            readImg(this.files[0]);
            processImage();
        }
    });

    function readImg(file) {
        let reader = new FileReader();
        reader.onload = function (e) {
            let img = e.target.result;
            OUTPUT.innerHTML = '<img src="' + img + '" alt="output image" id="output-image" class="img-fluid">';
            document.getElementsByClassName("center")[0].setAttribute("style", "height: auto;");
        };
        reader.readAsDataURL(file);
    }

    function processImage() {
        $.post({
            headers: {
                authorization: AUTH
            },
            url: PROXY_URL + 'cloud.ocrsdk.com/processImage?exportFormat=xml&profile=TextExtraction&language=English',
            data: new FormData($('form')[0]),

            cache: false,
            contentType: false,
            processData: false
        }).done(function (resp) {
            console.log('processImage', resp);
            taskId = resp.firstChild.firstChild.getAttribute('id');
            getTaskStatus(taskId)
        });
    }

    function getTaskStatus(taskId) {
        $.get({
            url: PROXY_URL + 'cloud.ocrsdk.com/getTaskStatus?taskId=' + taskId,
            headers: {
                authorization: AUTH
            }
        }).done(function (resp) {
            console.log('getTaskStatus', resp);
            let status = resp.firstChild.firstChild.getAttribute('status');
            if (status === 'Completed') {
                let resultUrl = resp.firstChild.firstChild.getAttribute('resultUrl');
                getXMLResult(resultUrl);
                putInAnswer({});
            } else {
                setTimeout(function () {
                    getTaskStatus(taskId);
                }, 5000);
            }
        });
    }

    function getXMLResult(resultUrl) {
        $.get({
            url: resultUrl.replace('https://', PROXY_URL)
        }).done(function (resp) {
            console.log('getXMLResult', resp);
            parseXML(resp);
        });
    }

    function putInAnswer(answer) {
        let fakedata = [
            {width: 200, height: 30, left: 10, top: 100, text: "10000"},
            {width: 10, height: 30, left: 10, top: 40, text: "20000"},
            {width: 200, height: 30, left: 155, top: 200, text: "400"},
            {width: 20, height: 30, left: 300, top: 100, text: "101"}
        ];

        for (let i = 0; i < fakedata.length; i++) {
            let data = fakedata[i];
            let span_html_text = createSpanHelper(data);
            $("#output").append(span_html_text);
        }

        function createSpanHelper(data) {
            const IMG = document.getElementById("output-image");
            return `<span class="result" style=" \
                    width:${data.width}px;  height:${data.height}px; \
                    left:${data.left / IMG.width * 100}%; top:${data.top / IMG.height * 100}%;"> ${data.text} </span>`;
        }
    }

    function parseXML(resp) {
        let equs = [];
        let lines = resp.getElementsByTagName('line');
        for(let i = 0; i < lines.length; i++){
            let aline = lines[i];
            let strs = aline.getElementsByTagName('charParams');
            let equ = '';
            for(let j = 0; j < strs.length; j++){
                equ += strs[j].childNodes[0].nodeValue;
            }
            equs[i] = {
                equ: equ,
                l: Number(aline.getAttribute('l')),
                t: Number(aline.getAttribute('t')),
                r: Number(aline.getAttribute('r')),
                b: Number(aline.getAttribute('b'))
            };
        }
        console.log('parseXML', equs);
        smooth(equs);
    }

    function smooth(equs) {
        let rep = [
            [/—/g, '-'],
            [/二/g, '='],
            [/f/g, '+'],
            [/I/g, '+'],
            [/•/g, '+'],
            [/L/g, '1'],
            [/—/g, '-'],
            [/o/g, '0'],
            [/i/g, '1'],
            [/l/g, '1'],
            [/x/g, '*'],
            [/»/g, '+'],

            [/^.*\./, ''], // `1.2+3-4` -> `2+3-4`
            [/^.*\(\d+\)/, ''] // `  (12) 2 + 3` -> ` 2 + 3`
        ];

        for (let ei in equs) {
            let e = equs[ei];
            console.log('smoothing', e.equ);

            for (let ri in rep) {
                e.equ = e.equ.replace(rep[ri][0], rep[ri][1]);
            }

            let c = e.equ.replace(/[^\d=+*\-\s]/g, ''); // `ab  123+ 3` -> `  123+ 3`
            if (c.length >= 3 && e.equ.length < c.length * 2) {
                e.equ = c.replace(/[=\-] *$/, ''); // `1 + 2 - ` -> `1 + 2 `
                if (e.equ.search(/[+*\-]/) > 0) { // must have at least an operator
                    console.log('smoothed', e.equ);
                    try {
                        e.ans = eval(e.equ);
                        writeEqu(e);
                    } catch (err) {
                        console.log('eval error:', e.equ);
                    }
                }
            }
        }
    }

    function writeEqu(e) {
        console.log('writeEqu', e.equ, e.ans);
    }
</script>
</html>